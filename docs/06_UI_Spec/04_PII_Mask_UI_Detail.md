# 04_PII_Mask_UI_Detail

## PII マスク確認画面の概要

### 設計原則
- **ユーザー確認必須**：自動検出だけでなくユーザーによる最終確認を強制
- **透明性**：検出された PII をすべて表示し、信頼度を明確に示す
- **制御可能性**：ユーザーが手動でマスク対象を追加可能
- **不可逆性**：自動検出マスクは削除不可（削除されると PII が再度送信される可能性）

## 画面レイアウト

```
┌─────────────────────────────────────────────────┐
│  セミトランスパレント背景 (opacity: 0.5)       │
│                                                   │
│  ┌───────────────────────────────────────────┐  │
│  │ ▲ PII が検出されました                      │  │
│  ├───────────────────────────────────────────┤  │
│  │                                               │  │
│  │ [マスク済画像プレビュー]                    │  │
│  │ （セミトランスパレント白背景）              │  │
│  │ 画像上に黒ボックス（マスク）表示            │  │
│  │                                               │  │
│  ├───────────────────────────────────────────┤  │
│  │ 検出された情報:                             │  │
│  │ ☑️ メールアドレス (信頼度: 95%) [▮▮▮▮▮]   │  │
│  │ ☑️ 電話番号 (信頼度: 87%) [▮▮▮▮]         │  │
│  │ ☑️ 住所 (信頼度: 72%) [▮▮▮]              │  │
│  │ ☑️ 氏名 (信頼度: 91%) [▮▮▮▮]             │  │
│  │                                               │  │
│  ├───────────────────────────────────────────┤  │
│  │ [+ さらにマスク対象を追加]                  │  │
│  │                                               │  │
│  ├───────────────────────────────────────────┤  │
│  │ [キャンセル]         [送信]                  │  │
│  └───────────────────────────────────────────┘  │
│                                                   │
└─────────────────────────────────────────────────┘
```

## セミトランスパレント背景

### CSS スタイル
```css
.pii-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5); /* 50% 透明 */
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10001;
}

.pii-dialog {
  background-color: #ffffff;
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  padding: 24px;
}
```

## マスク済画像表示

### 表示方式
- **背景**：セミトランスパレント白（rgba(255, 255, 255, 0.8)）
- **枠線**：薄いグレー（#CCCCCC）
- **マスク表示**：黒いボックス/矩形（rgba(0, 0, 0, 0.8)）
- **インタラクティブ**：ホバーで マスク領域が点滅（animation）

### 実装例（Canvas）
```javascript
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

// 元画像描画
ctx.drawImage(preprocessedImage, 0, 0);

// PII 領域にマスク（黒いボックス）を描画
detectedPIIBoundingBoxes.forEach(bbox => {
  ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
  ctx.fillRect(bbox.x, bbox.y, bbox.width, bbox.height);
  
  // 枠線（オプション）
  ctx.strokeStyle = '#FF0000';
  ctx.lineWidth = 2;
  ctx.strokeRect(bbox.x, bbox.y, bbox.width, bbox.height);
});

// Canvas を Data URL に変換
const maskedImageDataURL = canvas.toDataURL('image/png');
```

### 画像サイズ
- **表示サイズ**：400px × 300px（アスペクト比保持）
- **元画像**：1600px × 1200px（前処理後）

## 信頼度レベル別の色分け

### 色分けルール

| 信頼度 | 範囲 | 色 | 表現 | 意味 |
|---------|-----|----|----|------|
| **高** | ≥90% | **緑** 🟢 | [▮▮▮▮▮] | 自動マスク確実。削除不可 |
| **中** | 75-89% | **オレンジ** 🟡 | [▮▮▮▮] | 自動マスク。確認推奨 |
| **低** | <75% | **赤** 🔴 | [▮▮▮] | 自動マスク。ユーザー確認必須 |

### UI 表示例
```
☑️ メールアドレス (信頼度: 95%)
   🟢 [▮▮▮▮▮] 自動検出・マスク済み

☑️ 電話番号 (信頼度: 82%)
   🟡 [▮▮▮▮] 自動検出・マスク済み

☑️ 郵便番号 (信頼度: 68%)
   🔴 [▮▮▮] 自動検出・マスク済み（確認推奨）
```

## 検出された PII リスト表示

### 表示フォーマット
```
検出された情報:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

☑️ メールアドレス × 2 件
   信頼度: 95%, 91%
   例: [user****@example.com] (一部秘匿化)

☑️ 電話番号 × 1 件
   信頼度: 87%
   例: [0XX-XXXX-XXXX] (一部秘匿化)

☑️ 住所 × 1 件
   信頼度: 72%
   例: [東京都...] (一部秘匿化)

☑️ 氏名 × 1 件
   信頼度: 91%
   例: [田中****] (一部秘匿化)

☑️ 郵便番号 × 1 件
   信頼度: 88%
```

### チェックボックス
- **状態**：すべてデフォルトで ☑️ チェック済み
- **機能**：
  - チェック ON → マスク適用
  - チェック OFF → マスク削除（ただし自動検出は外せない）
- **外見**：
  - 自動検出：☑️ (disabled チェックボックス)
  - 手動追加：☑️ (enabled チェックボックス、削除可能)

## 手動マスク追加機能

### UI ボタン
```
[+ さらにマスク対象を追加]
```

### ユーザー操作フロー
1. ボタンクリック → マウスモード ON
2. 画像上でドラッグ選択 → 選択領域を矩形表示（点線）
3. マウスアップ → 「新しいマスク領域を追加しますか？」確認ダイアログ
4. 「追加」クリック → マスク領域に黒いボックスを追加
5. ボタン再クリック → マウスモード OFF

### 実装例（JavaScript）
```javascript
let isDrawingMode = false;
let startX, startY;

canvas.addEventListener('mousedown', (e) => {
  if (!isDrawingMode) return;
  startX = e.offsetX;
  startY = e.offsetY;
});

canvas.addEventListener('mousemove', (e) => {
  if (!isDrawingMode) return;
  // ドラッグ選択を表示（点線矩形）
});

canvas.addEventListener('mouseup', (e) => {
  const width = e.offsetX - startX;
  const height = e.offsetY - startY;
  
  // 確認ダイアログ表示
  confirmAddMask(startX, startY, width, height);
});
```

### 制約事項
- **最大追加数**：10 個（過度な手動マスクを防止）
- **最小サイズ**：10px × 10px（ノイズ防止）
- **最大サイズ**：画像幅/高さの 90%

## 自動検出マスクの削除不可制御

### 設計理由
- **セキュリティ**：自動検出された PII を削除させると、マスク済画像にも関わらず PII が露出
- **コンプライアンス**：ユーザーによる意図的な PII 削除を防止

### UI 実装
```javascript
// 自動検出 PII のチェックボックスは disabled
<input type="checkbox" checked disabled>
```

### メッセージ表示
```
ℹ️ 自動検出されたマスク対象は削除できません。
   ご不明な点はサポートまでお問い合わせください。
```

## キャンセル / 送信ボタン

### キャンセルボタン
- **ラベル**：「キャンセル」
- **色**：灰色（#808080）
- **動作**：
  - PII_REVIEW 状態をキャンセル
  - IDLE 状態に戻す
  - ユーザーに画像と入力が保持されたまま（再度「送信」可能）

### 送信ボタン
- **ラベル**：「送信」
- **色**：青色（#0078D4）
- **動作**：
  - マスク確認完了を記録（Event: `pii_review_submitted`）
  - マスク済画像とテキストを送信（SENDING 状態へ）
  - 画面をクリア

## モバイル対応

### タッチデバイス
- **ドラッグ選択**：タッチ AND ドラッグで対応
- **ボタン**：最小 44px × 44px
- **画面幅**：全体的に responsive（max-width: 90vw）

### 小画面時の調整
- ダイアログ width：90vw（最大 500px）
- マスク済画像：全幅表示
- フォント：14px → 12px に削減

