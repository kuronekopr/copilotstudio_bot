# 06_Error_and_Edge_Cases

## エラーハンドリング戦略

### 原則
1. **ユーザーフレンドリー**：技術的エラーを簡潔な日本語で説明
2. **リトライ可能**：重大な損失がないエラーはリトライオプション提供
3. **詳細ログ**：内部ログには詳細なエラー情報を記録
4. **グレースフルデグラデーション**：部分的な機能低下でもサービス継続

## エラーカテゴリと対応

### カテゴリ 1: ファイルアップロードエラー

#### 1.1 ファイル形式エラー
```
シナリオ: SVG 形式のファイルをアップロード
ユーザーメッセージ: 「SVG 形式はサポートされていません。JPEG または PNG 形式をお使いください」
ユーザー操作: ファイル選択画面に戻る、別のファイル選択
内部ログ: {
  "event": "file_format_error",
  "detected_format": "image/svg+xml",
  "user_file_name": "diagram.svg",
  "timestamp": "2025-02-16T10:30:00Z",
  "action_taken": "rejected"
}
リトライ: Yes
```

#### 1.2 ファイルサイズ超過
```
シナリオ: 6MB の画像をアップロード
ユーザーメッセージ: 「ファイルサイズが大きすぎます。最大 5MB までの画像をお選びください」
ユーザー操作: ファイルを圧縮して再度アップロード
内部ログ: {
  "event": "file_size_exceeded",
  "file_size_bytes": 6291456,
  "max_allowed_bytes": 5242880,
  "timestamp": "2025-02-16T10:30:00Z"
}
リトライ: Yes
```

#### 1.3 最大枚数超過
```
シナリオ: 5 枚選択済みで 6 枚目を追加
ユーザーメッセージ: 「画像は最大 5 枚までです」
ユーザー操作: 既存画像を削除してから再度アップロード
内部ログ: {
  "event": "max_images_exceeded",
  "current_count": 5,
  "max_allowed": 5,
  "attempted_count": 6
}
リトライ: Yes（ただし既存画像削除後）
```

#### 1.4 重複ファイル
```
シナリオ: 同じ SHA-256 ハッシュの画像を再度アップロード
ユーザーメッセージ: 「この画像はすでに選択されています」（警告）
ユーザー操作: 異なる画像を選択
内部ログ: {
  "event": "duplicate_file_detected",
  "file_hash": "a3f5b2c1d...",
  "timestamp": "2025-02-16T10:30:00Z",
  "action": "warned"
}
リトライ: No（警告のみ）
```

### カテゴリ 2: 画像前処理エラー

#### 2.1 EXIF 削除失敗
```
シナリオ: EXIF データが破損している画像
ユーザーメッセージ: 「画像処理中にエラーが発生しました。別の画像をお試しください」
ユーザー操作: ファイル削除、別画像を選択
内部ログ: {
  "event": "exif_removal_failed",
  "error_type": "malformed_exif",
  "file_hash": "a3f5b2c1d...",
  "error_detail": "EXIF segment not parseable",
  "timestamp": "2025-02-16T10:30:00Z"
}
リトライ: Yes（別のファイルで）
```

#### 2.2 リサイズ失敗
```
シナリオ: 破損した画像ファイル
ユーザーメッセージ: 「画像の読み込みに失敗しました」
ユーザー操作: ファイル削除、別画像を選択
内部ログ: {
  "event": "image_resize_failed",
  "error_type": "decode_error",
  "file_hash": "a3f5b2c1d...",
  "error_detail": "Invalid JPEG header"
}
リトライ: Yes（別のファイルで）
```

#### 2.3 ハッシュ生成失敗
```
シナリオ: メモリ不足でハッシュ計算が失敗
ユーザーメッセージ: 「処理中にエラーが発生しました。時間をおいてお試しください」
ユーザー操作: しばらく待機後、再度送信
内部ログ: {
  "event": "hash_generation_failed",
  "error_type": "memory_error",
  "timestamp": "2025-02-16T10:30:00Z"
}
リトライ: Yes（時間経過後）
```

#### 2.4 タイムアウト（前処理 >10 秒）
```
シナリオ: JavaScript WebWorker が 10 秒以上応答しない
ユーザーメッセージ: 「画像の処理がタイムアウトしました。もう一度お試しください」
ユーザー操作: キャンセルして再度アップロード
内部ログ: {
  "event": "preprocessing_timeout",
  "elapsed_ms": 10500,
  "timeout_ms": 10000,
  "timestamp": "2025-02-16T10:30:00Z"
}
リトライ: Yes
```

### カテゴリ 3: OCR / PII 検出エラー

#### 3.1 OCR 失敗
```
シナリオ: Azure Computer Vision API が一時的に利用不可
ユーザーメッセージ: 「画像の分析中にエラーが発生しました。もう一度お試しください」
ユーザー操作: 「再度送信」ボタンクリック
内部ログ: {
  "event": "ocr_failure",
  "error_type": "api_error",
  "api_response_code": 503,
  "retry_count": 1,
  "timestamp": "2025-02-16T10:30:00Z"
}
リトライ: Yes（自動リトライ 3 回まで）
```

#### 3.2 PII 検出失敗
```
シナリオ: スコアリングモデルの推論エラー
ユーザーメッセージ: 「内容の分析に失敗しました。別のご質問でお試しください」
ユーザー操作: 質問を変更して再度送信
内部ログ: {
  "event": "pii_detection_failure",
  "error_type": "model_inference_error",
  "model_version": "v1.2.3",
  "error_detail": "CUDA out of memory",
  "timestamp": "2025-02-16T10:30:00Z"
}
リトライ: Yes（同じセッション内で）
```

#### 3.3 タイムアウト（OCR/PII >30 秒）
```
シナリオ: バックエンド API が遅延
ユーザーメッセージ: 「処理に時間がかかっています。もう一度お試しください」
ユーザー操作: キャンセルまたは再度送信
内部ログ: {
  "event": "backend_processing_timeout",
  "component": "pii_detection",
  "elapsed_ms": 30500,
  "timeout_ms": 30000,
  "timestamp": "2025-02-16T10:30:00Z"
}
リトライ: Yes
```

### カテゴリ 4: ネットワークエラー

#### 4.1 ネットワーク切断
```
シナリオ: 送信中にインターネット接続が切れる
ユーザーメッセージ: 「ネットワーク接続がありません。接続を確認してください」
ユーザー操作: Wi-Fi/モバイル接続を確認後、「再度送信」
内部ログ: {
  "event": "network_disconnected",
  "state": "sending",
  "timestamp": "2025-02-16T10:30:00Z"
}
リトライ: Yes（接続復帰後）
```

#### 4.2 タイムアウト（API 呼び出し）
```
シナリオ: サーバーからの応答がない（30 秒以上）
ユーザーメッセージ: 「サーバーからの応答がありません。もう一度お試しください」
ユーザー操作: 「再度送信」ボタンクリック
内部ログ: {
  "event": "api_timeout",
  "endpoint": "/api/chat/send",
  "elapsed_ms": 30500,
  "timeout_ms": 30000
}
リトライ: Yes
```

### カテゴリ 5: ボット応答エラー

#### 5.1 スコアリング失敗
```
シナリオ: ボット側スコアリングエンジンがエラー
ユーザーメッセージ: 「申し訳ございません。自動回答に失敗しました。サポートへお繋ぎします」
画面遷移: 自動的に ESCALATE 画面へ
内部ログ: {
  "event": "scoring_failed",
  "error_type": "model_error",
  "timestamp": "2025-02-16T10:30:00Z",
  "fallback_action": "escalate"
}
リトライ: No（自動 escalate）
```

#### 5.2 回答生成失敗
```
シナリオ: LLM が回答を生成できない
ユーザーメッセージ: 「申し訳ございません。回答生成に失敗しました。サポートへお繋ぎします」
画面遷移: ESCALATE 画面へ
内部ログ: {
  "event": "response_generation_failed",
  "error_type": "llm_error",
  "timestamp": "2025-02-16T10:30:00Z"
}
リトライ: No
```

## エッジケース処理

### エッジケース 1: 空のテキスト入力
```
シナリオ: ユーザーが画像のみを送信（テキストなし）
処理: 
- フロントエンド検証：「テキストを入力してください」警告
- または許可（実装次第）
ユーザーメッセージ: 「ご質問を入力してください」または許可して続行
内部ログ: {
  "event": "empty_text_input",
  "action": "warn" または "allow"
}
```

### エッジケース 2: 極めて短いテキスト
```
シナリオ: ユーザーが「はい」「いいえ」のみ入力
処理:
- バックエンド検証：スコアリング精度が低下する可能性
- ASK_CLARIFICATION で追加質問を促す
内部ログ: {
  "event": "very_short_input",
  "input_length": 2,
  "threshold": 10
}
```

### エッジケース 3: 画像にテキストなし
```
シナリオ: テキストのない画像のみの質問
処理:
- OCR で画像からテキストを抽出（オプション）
- または「ご質問をテキストで説明してください」と促す
ユーザーメッセージ: 「ご質問をテキストでも説明していただくと、より正確な回答ができます」
```

### エッジケース 4: PII が検出されない
```
シナリオ: OCR で テキストが検出されたがPII なし
処理:
- 通常通りボット処理へ
- PII_REVIEW 画面をスキップ
- 「PII は検出されませんでした」メッセージ表示（オプション）
内部ログ: {
  "event": "no_pii_detected",
  "ocr_text_detected": true,
  "pii_count": 0
}
```

### エッジケース 5: OCR 失敗だが処理継続
```
シナリオ: 画像が不鮮明で OCR 失敗
処理:
- PII 検出をスキップ
- ユーザーに通知：「画像が不鮮明な可能性があります」
- ボット処理は継続（テキストのみで処理）
内部ログ: {
  "event": "ocr_failed_but_continue",
  "user_text_available": true,
  "action": "skip_pii_detection"
}
```

### エッジケース 6: ダブルサブミット（二重送信）
```
シナリオ: ユーザーが「送信」ボタンを 2 回クリック
対策:
- ボタンを送信中に無効化（disabled 属性）
- クライアント側で idempotency key を使用
- バックエンド側で重複検出（message_id ベース）
ユーザーメッセージ: なし（UI で防止）
内部ログ: {
  "event": "duplicate_submit_prevented",
  "idempotency_key": "msg-xxxxx",
  "action": "ignored_second_submit"
}
```

### エッジケース 7: セッション有効期限切れ
```
シナリオ: チャットを長時間放置（>24 時間）
処理:
- トークンの自動更新
- または「セッションが有効期限切れです」と通知し、リセット
ユーザーメッセージ: 「申し訳ございません。セッションが期限切れになりました。ページをリロードしてください」
内部ログ: {
  "event": "session_expired",
  "elapsed_hours": 25,
  "action": "session_reset"
}
```

### エッジケース 8: メモリ不足（大量の画像処理）
```
シナリオ: 複数ユーザーが同時に大量の画像を送信
処理:
- キューイングシステム
- リトライロジック
- ユーザーに「処理中です。少々お待ちください」
ユーザーメッセージ: 「申し訳ございません。現在処理が混雑しています。時間をおいてお試しください」
内部ログ: {
  "event": "high_load_detected",
  "queue_length": 50,
  "estimated_wait_seconds": 120
}
```

## エラーリカバリーフロー

```
エラー発生
  ↓
[エラーダイアログ表示]
  ├─ ユーザーフレンドリーメッセージ
  ├─ リトライボタン（リトライ可能な場合）
  └─ キャンセルボタン（IDLE 状態へ戻る）
  ↓
ユーザー操作
  ├─ 「再度送信」クリック → SENDING 状態へ（最大 3 回まで）
  ├─ 「キャンセル」クリック → IDLE 状態へ、データ保持
  └─ 時間経過後に再度「送信」可能
  ↓
リトライ回数 > 3 の場合 → ESCALATE に自動遷移
```

