# 05_Decision_Display_Spec

## 自動判定結果の表示仕様

ボット側のスコアリングエンジンが決定した 3 つの結果パターンに対応する UI 表示

## パターン 1: AUTO_RESOLVE（自動解決）

### 決定条件
```
スコアリングスコア ≥ threshold_auto_resolve (例: 0.70)
```

### 画面構成
```
┌─────────────────────────────────────────────┐
│ ✅ ご質問にお応えしました                    │
├─────────────────────────────────────────────┤
│                                               │
│ [ボットが生成した回答テキスト]               │
│                                               │
│ Lorem ipsum dolor sit amet, consectetur...   │
│ Sed do eiusmod tempor incididunt...         │
│                                               │
├─────────────────────────────────────────────┤
│ 関連する FAQ:                                │
│ • FAQ1: 〇〇について                        │
│ • FAQ2: ××××とは                           │
│ • FAQ3: □□□□方法                          │
│                                               │
├─────────────────────────────────────────────┤
│ この回答は役に立ちましたか？                │
│                                               │
│ [👍 役に立った]  [👎 役に立たなかった]     │
├─────────────────────────────────────────────┤
│ ご不明な点はサポートまでお問い合わせください│
│ [🔗 お問い合わせフォーム]                   │
└─────────────────────────────────────────────┘
```

### 表示要素

#### 1. ヘッダー
```
✅ ご質問にお応えしました
```
- アイコン：チェックマーク（🟢✅）
- 背景色：薄い緑（#E8F5E9）
- フォント：太字、16px

#### 2. 回答テキスト
- **形式**：Markdown サポート（太字、リスト、リンク等）
- **最大長**：2000 文字
- **表示**：スクロール可能エリア（max-height: 300px）
- **例**：
  ```
  お客様のご質問ありがとうございます。
  
  ### 解決方法
  1. [ここから](https://example.com) アクセス
  2. ログイン情報を入力
  3. 設定を確認
  ```

#### 3. 関連 FAQ リンク
```
関連する FAQ:
• [FAQ1: 〇〇について](https://faq.example.com/1)
• [FAQ2: ××××とは](https://faq.example.com/2)
• [FAQ3: □□□□方法](https://faq.example.com/3)
```
- **表示数**：3～5 件
- **取得元**：RAG（検索結果の上位 N 件）
- **リンク**：外部リンク（target="_blank"）
- **フォント**：14px、青色（#0078D4）

#### 4. 満足度投票
```
この回答は役に立ちましたか？

[👍 役に立った]  [👎 役に立たなかった]
```
- **投票ボタン**：2 択
- **ホバー効果**：背景色変化（#F0F0F0 → #E0E0E0）
- **クリック後**：ボタン無効化、「ご投票ありがとうございました」メッセージ表示
- **Event 記録**：`satisfaction_voted`, vote_value (1 or 0)

#### 5. サポートリンク
```
ご不明な点はサポートまでお問い合わせください
[🔗 お問い合わせフォーム]
```
- **リンク先**：Escalation フォーム（別ウィンドウ）
- **色**：灰色リンク（#666666）
- **フォント**：12px

## パターン 2: ASK_CLARIFICATION（追加質問）

### 決定条件
```
threshold_escalate < スコアリングスコア < threshold_auto_resolve
例：0.40 < score < 0.70
```

### 画面構成
```
┌─────────────────────────────────────────────┐
│ ❓ さらに詳しくお聞きさせてください         │
├─────────────────────────────────────────────┤
│                                               │
│ [ボットからの追加質問テキスト]               │
│                                               │
│ ご質問について、以下のことを教えていただけ │
│ ますか？                                     │
│ • 〇〇の対象期間は？                        │
│ • ××××の状況は？                          │
│                                               │
├─────────────────────────────────────────────┤
│ [テキスト入力欄 (複数行対応)]               │
│                                               │
│ [キャンセル]         [回答する]              │
└─────────────────────────────────────────────┘
```

### 表示要素

#### 1. ヘッダー
```
❓ さらに詳しくお聞きさせてください
```
- アイコン：クエスチョンマーク（❓）
- 背景色：薄い青（#E3F2FD）
- フォント：太字、16px

#### 2. 追加質問テキスト
- **形式**：Markdown サポート
- **最大長**：1000 文字
- **表示**：スクロール可能（max-height: 200px）
- **例**：
  ```
  ご質問について、以下の情報があると、
  より正確なご回答ができます。
  
  • 対象の契約プランは？
  • 発生日時は？
  • すでに試された対応策は？
  ```

#### 3. 入力フォーム
- **テキストエリア**：rows="5", min-height: 100px
- **プレースホルダー**：「ご回答をこちらに入力してください」
- **キーボード操作**：Ctrl+Enter または Shift+Enter で送信

#### 4. ボタン
- **キャンセルボタン**：灰色、ダイアログクローズ（IDLE 状態）
- **回答するボタン**：青色、テキスト送信（SENDING 状態へ）

#### 5. 動作フロー
```
ユーザー入力 → 「回答する」クリック
    ↓
[新しい入力画像なし、テキストのみを送信]
    ↓
SENDING 状態
    ↓
バックエンド：追加情報を含めて再スコアリング
    ↓
AUTO_RESOLVE または もう一度 ASK_CLARIFICATION または ESCALATE
```

## パターン 3: ESCALATE（エスカレーション）

### 決定条件
```
スコアリングスコア ≤ threshold_escalate (例: 0.40)
```

### 画面構成
```
┌─────────────────────────────────────────────┐
│ 📞 サポートへお繋ぎします                    │
├─────────────────────────────────────────────┤
│                                               │
│ 申し訳ございません。                         │
│ 自動ご回答では対応できないご質問のようです。 │
│                                               │
│ 人間のサポートスタッフがお手伝いさせていただ│
│ きます。                                     │
│                                               │
├─────────────────────────────────────────────┤
│ セッション情報                                │
│ • ご質問概要：[元のテキスト（最初の50文字）]│
│ • セッション ID：xxxxx-xxxxx                │
│                                               │
├─────────────────────────────────────────────┤
│ [🔗 お問い合わせフォームに移動する]        │
│    （または自動リダイレクト 10 秒後）      │
│                                               │
│ ⏱️ 10 秒でフォーム画面に移動します...      │
└─────────────────────────────────────────────┘
```

### 表示要素

#### 1. ヘッダー
```
📞 サポートへお繋ぎします
```
- アイコン：電話（📞）
- 背景色：薄いオレンジ（#FFF3E0）
- フォント：太字、16px

#### 2. メッセージテキスト
```
申し訳ございません。
自動ご回答では対応できないご質問のようです。

人間のサポートスタッフがお手伝いさせていただきます。
```

#### 3. セッション情報
```
セッション情報
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• ご質問概要：[元のテキスト最初50文字...]
• 質問言語：日本語
• セッション ID：sess-a1b2c3d4e5f6
• 検出 PII 種別：メール、電話（秘匿化）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 4. リダイレクトボタン
```
[🔗 お問い合わせフォームに移動する]
```
- **スタイル**：青色ボタン、矢印アイコン
- **動作**：フォーム画面にリダイレクト
- **データ引継ぎ**：
  - `session_id` = 現在のセッション ID
  - `summary` = ご質問テキスト + セッション情報
  - `images` = マスク済画像ファイル（フォーム側で自動添付）

#### 5. カウントダウン表示
```
⏱️ 10 秒でフォーム画面に移動します...
9秒...
8秒...
...
```
- **自動リダイレクト**：10 秒後に自動移動
- **キャンセル可能**：ボタン手動クリックで即座に移動
- **背景実行**：バックエンドに escalation event を記録

## 共通要素: エラー メッセージ

### タイムアウト（WAITING_RESPONSE で 30 秒超過）
```
┌─────────────────────────────────────────────┐
│ ⚠️ 申し訳ございません                        │
├─────────────────────────────────────────────┤
│ サーバーからの応答がありません。             │
│ もう一度お試しいただくか、サポートまで      │
│ お問い合わせください。                       │
│                                               │
│ [再度送信]  [お問い合わせ]                  │
└─────────────────────────────────────────────┘
```

### ネットワークエラー
```
┌─────────────────────────────────────────────┐
│ ❌ ネットワークエラー                         │
├─────────────────────────────────────────────┤
│ インターネット接続を確認してください。       │
│                                               │
│ [再度送信]  [キャンセル]                     │
└─────────────────────────────────────────────┘
```

