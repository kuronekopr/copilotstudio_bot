# ネットワーク／セキュリティ・プロファイル（実装ガイド）

本書は、/01_Architecture で定義した構成に対し、「どこを」「何で」守るかを、実装・レビュー向けに一覧化する。

---

## 1. エッジ（Internet境界）

### 1.1 WAF / DDoS（推奨）
- 目的：L7攻撃、ボット、悪性ペイロード、DoSの一次遮断
- 実装候補：既存WAF / CDN、Azure Front Door / Application Gateway WAF

### 1.2 レート制御（必須）
- 対象：チャット起動／トークン発行、画像送信
- 指針：1 IP/セッションあたりのQPS上限、バースト許容＋バックオフ
- 備考：匿名利用前提のため、レート制御は特に重要

---

## 2. クライアント（Browser）入力制御（必須）

### 2.1 画像前処理（必須）
- 長辺1600pxへリサイズ
- JPEG品質80%
- 5MB制限
- EXIF削除（個人情報・位置情報リスク低減）

### 2.2 ファイル種別制限（必須）
- SVG拒否（スクリプト混入のリスク）
- MIME二重検証（拡張子＋Content-Type＋シグネチャ）

---

## 3. Botチャネル境界（Direct Line）

### 3.1 Direct Lineトークン設計（必須）
- 短寿命トークン（推奨：数分単位）
- トークン発行はサーバ側で制御
- トークン発行エンドポイントにレート制御必須

### 3.2 送信サイズ制限（必須）
- 画像：最大5枚、合計サイズ上限（UIで先に弾く）

---

## 4. Copilot Studio（アプリケーション境界）

### 4.1 Prompt Injection対策（必須）
- 「画像→JSON抽出」→「クラスタ分類」→「RAG」→「統合回答」を段階化
- 中間出力（JSON）をスキーマで制約し、最終回答と分離

### 4.2 個人情報出力の抑止（必須）
- Prompt制御（個人情報出力禁止）

---

## 5. データ境界（ログ／ストレージ）

### 5.1 ログの構造化・保持（必須）
- ログは構造化JSON形式
- 1問い合わせ＝1イベント（Event Source）
- 保存期間：6〜12ヶ月
- 個人情報：マスキング必須
- 画像保存：原則保存しない（メタ情報のみ）

### 5.2 Blob（マスク済画像のみ保存する場合）
- Public Access 無効
- Private Endpoint / VNet制限
- 暗号化（at rest / in transit）
- ライフサイクル（保存期間に合わせて自動削除）

---

## 6. エスカレーション（フォーム連携）
- Webフォームへ引継ぎ：チャット要約、cluster_id、推定原因、参考FAQリンク
- 画像は再添付方式（安全設計）

---

## 7. セキュリティ検収（最低チェック項目）
- [ ] 画像：1600px/JPEG80%/EXIF削除/5MB/最大5枚（UIで拒否）
- [ ] SVG拒否（アップロード経路すべてで）
- [ ] ログ：構造化JSON、1イベント単位、保存期間6–12ヶ月
- [ ] フォーム引継ぎ：要約/cluster_id/原因/FAQリンク、画像は再添付
