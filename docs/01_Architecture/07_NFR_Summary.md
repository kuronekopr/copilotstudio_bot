# 非機能要件サマリ（NFR / SLO・運用）

本書は、アーキテクチャ観点で「最低限守るべき非機能」を定義する。数値は初期値（運用で見直し可能）。

---

## 1. スループット前提（規模感）
- 月200〜500件程度を前提とする

---

## 2. 性能（Performance）

### 2.1 クライアント制約（必須）
- 画像：最大5枚
- 1枚あたり：5MB制限
- 送信前に 1600px リサイズ＋JPEG80%圧縮

### 2.2 応答時間（目標SLO）
- P50：8秒以内
- P95：15秒以内

---

## 3. 可用性（Availability）

### 3.1 目標
- 月間稼働率：99%（目標）
- 依存サービス障害時の代替導線：フォーム誘導（必須）

### 3.2 劣化運転（Degraded mode）
- Copilot/Direct Line不可：チャット起動時にフォームへフォールバック
- RAG不可：一般ガイダンス＋フォーム誘導

---

## 4. 可観測性（Observability）

### 4.1 ログ（必須）
- 入力イベント生成、画像イベント記録、解析結果ログ、RAG検索ログ、回答ログ、エスカレーション記録が「必須」
- 1問い合わせ＝1イベント（構造化JSON）

### 4.2 KPI（最低限）
- 自己解決率
- 平均応答時間
- エスカレーション率
- クラスタ別件数

### 4.3 監視対象
- UNKNOWN比率（精度劣化指標）
- RAGヒット率低下検知
- 処理時間（必ず記録）

---

## 5. セキュリティ（Security NFR）

### 5.1 入力防御（必須）
- SVG拒否
- EXIF削除
- 5MB制限

### 5.2 個人情報（必須）
- ログの個人情報はマスキング必須
- 保存期間：6〜12ヶ月

---

## 6. 保守性（Maintainability）

### 6.1 段階化Prompt（必須）
- 画像→JSON抽出→クラスタ→RAG→統合回答のステップ分割で、差分テスト・回帰テストが可能

### 6.2 ナレッジ管理
- クラスタIDとFAQ紐付け管理表を持ち、RAG改善サイクルを回す

---

## 7. 互換性（Compatibility）
- 実装案：B案（Direct Line + カスタムWeb Chat）
  - 画像貼り付け実装可能
  - 画像処理は自前実装

---

## 8. 受入基準（NFR観点）
- [ ] 画像前処理（1600px/JPEG80%/5MB/最大5枚/EXIF削除）
- [ ] ログ必須6項目がイベントとして保存される
- [ ] 1問い合わせ＝1イベント（構造化JSON）
- [ ] 保存期間6〜12ヶ月／PIIマスキング
- [ ] 未解決時フォーム誘導＋引継ぎ項目が揃う
