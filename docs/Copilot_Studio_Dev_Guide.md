# Copilot Studio 開発・設定ガイド

本ドキュメントは、フロントエンドアプリケーション (`copilotstudio-bot`) と連携する **Microsoft Copilot Studio** ボットの作成および設定手順をまとめたものです。

## 1. 前提条件

- **Microsoft 365 テナント**: Copilot Studio のライセンスが必要です。
- **データソース**: RAG (検索拡張生成) に使用する SharePoint サイトや Web サイトの URL。
- **Azure OpenAI Service** (オプション): 標準の生成AI機能に加え、より高度な制御が必要な場合。

---

## 2. ボットの作成

1. [Microsoft Copilot Studio](https://copilotstudio.microsoft.com/) にログインします。
2. 左側メニューの **[作成]** をクリックし、**[新しいコパイロット]** を選択します。
3. **名前** を入力します (例: `HelpDeskSocketBot`)。
4. **言語** を「日本語」に設定します。
5. **[生成型 AI で会話を強化する]** にチェックを入れ、ナレッジソースとなる Web サイトの URL を入力します（後で変更可能）。
6. **[作成]** をクリックします。

---

## 3. 生成AIとナレッジの設定

### 3-1. ナレッジソースの追加

1. 上部メニューの **[設定] (歯車アイコン)** > **[生成 AI]** を開きます。
2. **[Web サイト]** や **[SharePoint]** セクションに、検索対象としたい URL を追加します。
3. **[保存]** をクリックします。

### 3-2. 生成AIの感度設定

1. 同画面の **[コンテンツのモデレーション]** 設定を確認します。
   - `高`: 回答が正確になりますが、回答できない頻度が増えます。
   - `中`: バランス型（推奨）。
   - `低`: 回答量が増えますが、不正確な情報の可能性があります。

---

## 4. トピックとシステムプロンプトの設定 (最重要)

フロントエンドは **JSON形式** のレスポンスを期待しています。標準の「会話の強化 (Conversational Boosting)」トピックをカスタマイズして、JSONを出力するように指示します。

### 4-1. システムプロンプトの編集

1. **[トピック]** > **[システム]** > **[会話の強化]** を開きます。
2. **[データソースの作成]** または **[生成AIノード]** のプロパティを開きます。
3. **[カスタム指示 (Custom Instructions)]** または **[追加の指示]** 欄に、以下のプロンプトを入力します。

```markdown
あなたは企業のヘルプデスクアシスタントです。
ユーザーの質問に対し、Knowledge Base (RAG) を検索して回答を作成してください。

### 重要: 出力フォーマット
回答は必ず以下の **JSON形式のみ** で出力してください。Markdownやプレーンテキストは含めないでください。

**JSONスキーマ:**
{
  "type": "message",
  "value": {
    "answerType": "AUTO_RESOLVE" | "ASK_CLARIFICATION" | "ESCALATE",
    "faqLinks": [
      { "title": "参考リンクタイトル", "url": "URL" }
    ],
    "text": "回答本文 (Markdown形式で記述。改行は \\n を使用)"
  }
}

### answerType の判断基準
1. **AUTO_RESOLVE**: ナレッジに十分な情報があり、回答可能な場合。
   - `text` には、「状況整理」「原因」「解決手順」を含めてください。
   - `faqLinks` には、参照元のURLを含めてください。

2. **ASK_CLARIFICATION**: ユーザーの質問が曖昧で、特定が必要な場合。
   - `text` に「どちらの製品ですか？」などの質問を含めてください。
   - `options` プロパティを追加して選択肢を提示することも可能です（高度な設定）。

3. **ESCALATE**: ナレッジに情報がない、または「担当者」「人間」というキーワードが含まれる場合。
   - `text` にはエスカレーションする旨（「担当者にお繋ぎします」など）を記述してください。

### 回答例
{
  "type": "message",
  "value": {
    "answerType": "AUTO_RESOLVE",
    "faqLinks": [
      { "title": "パスワードリセット手順", "url": "https://example.com/reset" }
    ],
    "text": "### 状況整理\nパスワードをお忘れのようですね。\n\n### 解決手順\n1. リセットページにアクセス\n2. メールアドレスを入力"
  }
}
```

4. **[保存]** をクリックします。

---

## 5. チャネル設定 (Direct Line)

フロントエンドアプリとの接続には **Direct Line** を使用します。

1. **[設定]** > **[チャネル]** を選択します。
2. **[モバイル アプリ]** (または Direct Line) を選択します。
   - ※表示されない場合は、管理者が許可していない可能性があります。
3. **[有効にする]** をクリックします。
4. **[トークン]** セクションの **[生成]** をクリックし、**シークレットキー (Secret)** をコピーします。
   - **注意**: このシークレットは他者に共有しないでください。

## 6. フロントエンドとの接続

1. 取得したシークレットキーを、フロントエンドプロジェクトの `.env` ファイルに設定します。

```env
VITE_DIRECT_LINE_SECRET=ここにコピーしたシークレットを貼り付け
```

2. アプリケーションを再起動 (`npm run dev`) します。
3. チャット画面からメッセージを送信し、Copilot Studio からの応答（JSONパースされた表示）が返ってくることを確認します。

## 7. トラブルシューティング

- **応答がJSONではない**:
  - システムプロンプトが正しく適用されているか確認してください。
  - 「会話の強化」トピック以外（例：挨拶トピック）がトリガーされている可能性があります。他のトピックもJSONを返すように修正するか、無効化してください。
- **CORSエラー**:
  - ローカル開発環境 (`localhost`) からのアクセスは通常許可されますが、Azure Bot Service 側の設定が必要な場合があります。
- **認証エラー (401/403)**:
  - シークレットキーが正しいか確認してください。
  - トークンの有効期限切れの可能性があります（フロントエンド実装では自動更新されますが、初期接続で失敗する場合はシークレットを再生成してください）。
